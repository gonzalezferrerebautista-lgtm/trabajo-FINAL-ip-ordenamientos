<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visualizador de Ordenamientos ‚Äî Python externo</title>
  <style>
    :root { --bg:#b1b1b1; --panel:#828282; --muted:#bfbfbf; --text:#1c1c1c; --accent:#d5f9ff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;background:linear-gradient(180deg,#ccddff,var(--bg));color:var(--text);min-height:100vh;display:grid;grid-template-rows:auto 1fr}
    header{padding:16px 20px;border-bottom:1px solid #1c1c1c;background:rgba(131, 131, 131, 0.75);backdrop-filter:blur(6px);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    h1{font-size:18px;margin:0;letter-spacing:.3px}
    .pill{padding:4px 10px;border-radius:999px;background:#1f2937;color:var(--muted);font-size:12px}
    main{padding:12px 16px 20px;display:grid;grid-template-rows:auto 1fr auto;gap:12px}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px;width:100%}
    .card{background:var(--panel);border:1px solid #a2a2a2;border-radius:14px;padding:12px}
    label{font-size:12px;color:var(--text);display:block;margin-bottom:6px}
    select,input[type=file]{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#8d8d8d;color:var(--text)}
    /* Estilos para sliders (color violeta) */
    input[type=range]{
      -webkit-appearance:none; appearance:none;
      width:100%; height:12px; border-radius:8px; background:transparent; margin:0; padding:0;
    }
    input[type=range]:focus{ outline:none; }
    input[type=range]::-webkit-slider-runnable-track{ height:12px; background:#6b6b6b; border-radius:8px; }
    input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:var(--accent); border:2px solid rgba(255,255,255,0.25); margin-top:-3px; }
    input[type=range]::-moz-range-track{ height:12px; background:#6b6b6b; border-radius:8px; }
    input[type=range]::-moz-range-thumb{ width:18px; height:18px; border-radius:50%; background:var(--accent); border:2px solid rgba(255,255,255,0.25); }
    /* Variable usada para el relleno din√°mico */
    input[type=range]{ --range-percent: 50%; background: linear-gradient(90deg, var(--accent) 0%, var(--accent) var(--range-percent), #6b6b6b var(--range-percent), #6b6b6b 100%); }
    .row{display:flex;align-items:center;gap:10px}
    .row>*{flex:1}
    .btns{display:flex;flex-wrap:wrap;gap:10px}
    button{background:#adadad;color:var(--text);border:1px solid #334155;padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .06s ease,border-color .2s ease}
    button:hover{border-color:var(--accent)}
    button:active{transform:translateY(1px)}
    button.primary{border-color:var(--accent);box-shadow:inset 0 0 0 1px var(--accent)}
    #canvasWrap{background:#969696;border:1px dashed #8db8f4;border-radius:16px;padding:10px;position:relative}
    #view{width:100%;height:64vh;display:block;border-radius:10px;background:radial-gradient(1000px 500px at 20% -10%,rgba(173, 244, 255, 0.08),transparent 70%),radial-gradient(900px 500px at 80% 110%,rgba(117, 71, 255, 0.08),transparent 70%),#adb0ba}
    .footer{color:var(--text);font-size:12px;text-align:center;padding:8px 0}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#848484;border:1px solid #334155;padding:2px 6px;border-radius:6px}
    .center{text-align:center}
    .metricas{color: var(--muted); font-size: 24px; background-color: #8a8a8a; display: flex; margin: 0 auto; margin-top: 20px; justify-content: center; align-items: center; width: auto; height: auto; border-radius: 12px;}
  </style>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js" defer></script>
  <script defer>
  'use strict';

  function $(id){ return document.getElementById(id); }

  var canvas = null, ctx = null, DPR = 1;
  function ensureCanvas(){
    var wrap = $('canvasWrap');
    if(!canvas){
      canvas = document.createElement('canvas');
      canvas.id = 'view';
      wrap.appendChild(canvas);
    }
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    var rect = wrap.getBoundingClientRect();
    canvas.width  = Math.floor(rect.width * DPR);
    canvas.height = Math.floor(rect.height * DPR);
    canvas.style.width  = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
  }
  window.addEventListener('resize', function(){ ensureCanvas(); draw(); });

  function clearCanvas(){
    if(!ctx) return;
    ctx.save();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.restore();
  }

  // Reparte 'total' en 'n' enteros que suman exactamente 'total'
  function columnWidths(n, total){
    var widths = new Array(n), accPrev = 0;
    for(var i=0;i<n;i++){
      var accNext = Math.round(((i+1) * total) / n);
      widths[i] = accNext - accPrev;
      accPrev = accNext;
    }
    return widths;
  }

  // ===== Estado =====
  var state = {
    mode: 'bars',
    items: [],
    original: [],
    running: false,
    speed: 50,
    highlight: {a:null,b:null},
    imageBitmap: null,
    metrics: {
      startTime: null,
      endTime: null,
      steps: 0,
      swaps: 0,
      comparisons: 0
    }
  };

  // ===== Helpers =====
  function randInt(min,max){ return (Math.random()*(max-min+1)+min)|0; }
  function shuffleArray(a){ for(var i=a.length-1;i>0;i--){ var j=randInt(0,i), t=a[i]; a[i]=a[j]; a[j]=t; } }

  // Rellena visualmente el input range seg√∫n su valor
  function setRangeFill(el){
    if(!el) return;
    var min = parseFloat(el.min) || 0;
    var max = parseFloat(el.max) || 100;
    var val = parseFloat(el.value);
    var pct = ((val - min) / (max - min)) * 100;
    el.style.setProperty('--range-percent', pct + '%');
    // fallback directo al background para navegadores que no eval√∫an var() en linear-gradient bien
    el.style.background = 'linear-gradient(90deg, var(--accent) 0%, var(--accent) ' + pct + '%, #6b6b6b ' + pct + '%, #6b6b6b 100%)';
  }

  // ===== Barras =====
  function makeBars(n){
    var vals = new Array(n);
    for(var i=0;i<n;i++) vals[i]=i+1;
    shuffleArray(vals);
    var out = new Array(n);
    for(var k=0;k<n;k++) out[k]={ value: vals[k], originalIndex: vals[k]-1 };
    return out;
  }

  // ===== Imagen por columnas =====
  function makeImageColumns(n){
    return new Promise(function(resolve){
      if(!state.imageBitmap){
        var off = document.createElement('canvas');
        off.width = 800; off.height = 500;
        var octx = off.getContext('2d');
        octx.imageSmoothingEnabled = false;
        var grad = octx.createLinearGradient(0,0,off.width,off.height);
        grad.addColorStop(0,'#e3b32d'); grad.addColorStop(1,'#eba749');
        octx.fillStyle = grad; octx.fillRect(0,0,off.width,off.height);
        state.imageBitmap = off; // canvas fuente
      }
      var img = state.imageBitmap, W = img.width, H = img.height;
      var colW = Math.max(1, Math.floor(W / n));
      var pieces = [];
      for(var i=0;i<n;i++){
        var slice = document.createElement('canvas');
        slice.width = colW; slice.height = H;
        var sctx = slice.getContext('2d');
        sctx.imageSmoothingEnabled = false;
        sctx.drawImage(img, i*colW,0,colW,H, 0,0,colW,H);
        pieces.push({ originalIndex:i, slice:slice });
      }
      shuffleArray(pieces);
      var out = new Array(n);
      for(var j=0;j<n;j++) out[j] = { value: pieces[j].originalIndex, bitmap: pieces[j].slice, originalIndex: pieces[j].originalIndex };
      resolve(out);
    });
  }

  // ===== Dibujo =====
  function draw(){
    if(!ctx) return;
    clearCanvas();

    var W = canvas.width, H = canvas.height;

    if(state.mode === 'bars'){
      var n = state.items.length; if(!n) return;
      var gap = Math.round(2 * DPR);
      var usable = W - gap*(n+1);
      if (usable < 1) return;

      var widths = columnWidths(n, usable);
      var maxVal = 1;
      for(var i=0;i<n;i++) if(state.items[i].value > maxVal) maxVal = state.items[i].value;

      var x = gap;
      for(var k=0;k<n;k++){
        var it = state.items[k];
        var w  = widths[k] | 0;
        var h  = Math.max(2*DPR, (it.value/maxVal) * (H - 10*DPR)) | 0;
        var y  = (H - h) | 0;
        var hi = (state.highlight.a===k || state.highlight.b===k);
        if (state.highlight.a === k) {
          ctx.fillStyle = '#8739bf'; // color para 'a'
        } else if (state.highlight.b === k) {
          ctx.fillStyle = '#d65e02'; // color para 'b'
        } else {
          ctx.fillStyle = '#334155'; // color normal
        }
        ctx.fillRect(x|0, y|0, w|0, h|0);
        x += w + gap;
      }

    } else {
      var n2 = state.items.length; if(!n2) return;
      var Himg = Math.floor(canvas.height * 0.9);
      var src = state.imageBitmap;
      var ratio = src ? (src.width/src.height) : (16/9);
      var Wimg = Math.floor(Himg * ratio);
      var startX = Math.floor((canvas.width - Wimg)/2);
      var startY = Math.floor((canvas.height - Himg)/2);

      var widths2 = columnWidths(n2, Wimg);
      var x2 = startX;

      ctx.imageSmoothingEnabled = false;

      for(var m=0;m<n2;m++){
        var bmp = state.items[m].bitmap;
        var w2  = widths2[m] | 0;
        var xx  = x2 | 0;
        var yy  = startY | 0;
        ctx.drawImage(bmp, 0,0,bmp.width,bmp.height, xx,yy, w2, Himg);
        if(state.highlight.a===m || state.highlight.b===m){
          ctx.strokeStyle='#b04a3f'; ctx.lineWidth=2*DPR;
          ctx.strokeRect(xx+1*DPR,yy+1*DPR,w2-2*DPR,Himg-2*DPR);
        }
        x2 += w2;
      }
    }
  }

  // ===== Pyodide =====
  var py = null, pyStepFn = null;
  function ensurePy(){
    return new Promise(function(resolve){
      if(py){ resolve(py); return; }
      loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.0/full/' })
        .then(function(p){ py = p; resolve(py); })
        .catch(function(e){ console.warn('Pyodide no disponible:', e); resolve(null); });
    });
  }
  function loadStudentCode(path){
    return fetch(path, { cache:'no-store' })
      .then(function(r){ if(!r.ok) throw new Error('fetch '+path+' '+r.status); return r.text(); })
      .then(function(code){ return py.runPythonAsync(code).then(function(){ return true; }); })
      .catch(function(e){ console.warn('Error cargando .py:', e); return false; });
  }
  function pyInit(values){
    if(!py) return Promise.resolve();
    py.globals.set('initial_values', values);
    return py.runPythonAsync('init(initial_values)').then(function(){
      pyStepFn = py.globals.get('step');
    });
  }
  function pyStep(){
    if(!pyStepFn) return { done:true };
    var res = pyStepFn();
    try { return res.toJs({ dict_converter: Object.fromEntries }); }
    finally { if(res && res.destroy) res.destroy(); }
  }

  // ===== Utilidades =====
  function getAlgoPyPath(){
    var name = $('algorithm').value.toLowerCase().replace(/[^a-z0-9_]/g,'');
    return 'algorithms/sort_' + name + '.py';
  }

  // ===== Control =====
  function rebuildData(){
    var n = parseInt($('size').value, 10);
    $('imgCols').textContent = String(n);
    $('imageCard').style.display = state.mode === 'imageCols' ? '' : 'none';

    // dataset y dibujo primero (para ver siempre algo)
    var afterData = function(){
      state.original = JSON.parse(JSON.stringify(state.items));
      state.highlight = {a:null,b:null};
      draw();

      // intentar leer Python
      ensurePy().then(function(p){
        if(!p){ $('modeExec').textContent = 'Demo JS'; return; }
        var path = getAlgoPyPath();
        loadStudentCode(path).then(function(ok){
          if(ok){
            pyInit(state.items.map(function(it){return it.value;})).then(function(){
              $('modeExec').textContent = 'Python: ' + path;
            });
          } else {
            $('modeExec').textContent = 'Demo JS';
          }
        });
      });
    };

    if(state.mode === 'bars'){
      state.items = makeBars(n);
      afterData();
    } else {
      makeImageColumns(n).then(function(items){
        state.items = items;
        afterData();
      });
    }
  }

  function onShuffle(){
    var after = function(){
      state.original = JSON.parse(JSON.stringify(state.items));
      state.highlight = {a:null,b:null};
      draw();
      ensurePy().then(function(p){
        if(!p) return;
        loadStudentCode(getAlgoPyPath()).then(function(ok){
          if(ok) pyInit(state.items.map(function(it){return it.value;}));
        });
      });
    };
    if(state.mode === 'bars'){
      shuffleArray(state.items); after();
    } else {
      makeImageColumns(state.items.length).then(function(items){
        state.items = items; after();
      });
    }
  }

  function run(){
    if(!pyStepFn) return;
    state.running = true;
    state.metrics = { startTime: performance.now(), endTime: null, steps: 0, swaps: 0, comparisons: 0 };
    var metricsInterval = setInterval(updateMetricsDisplay, 100); // actualizar cada 100ms
    (function loop(){
      if(!state.running) return;
      var t0 = performance.now();
      var act = pyStep();
      if(act.done){
        state.running=false;
        state.highlight = {a:null,b:null};
        state.metrics.endTime = performance.now();
        clearInterval(metricsInterval);
        draw();
        updateMetricsDisplay();
        return;
      }
      state.metrics.steps += 1;
      if(act.swap) state.metrics.swaps += 1;
      else if(act.a !== null && act.b !== null) state.metrics.comparisons += 1;
      state.highlight = { a: act.a, b: act.b };
      if(act.swap){
        var a=act.a, b=act.b, tmp=state.items[a];
        state.items[a]=state.items[b]; state.items[b]=tmp;
      }
      draw();
      var wait = Math.max(5, parseInt($('speed').value,10) - (performance.now()-t0)); // üëà m√≠nimo 5ms
      setTimeout(loop, wait);
    })();
  }
  function stepOnce(){
    if(!pyStepFn) return;
    var act = pyStep();
    if(act.done){
      state.running=false;
      state.highlight = {a:null,b:null};
      draw();
      return;
    }
    state.highlight = { a: act.a, b: act.b };
    if(act.swap){
      var a=act.a, b=act.b, tmp=state.items[a];
      state.items[a]=state.items[b]; state.items[b]=tmp;
    }
    draw();
  }
  function reset(){
    state.running=false;
    state.highlight = {a:null,b:null};
    state.items = JSON.parse(JSON.stringify(state.original));
    state.metrics = { startTime: null, endTime: null, steps: 0, swaps: 0, comparisons: 0 };
    updateMetricsDisplay();
    draw();
  }

  function formatTime(ms){
    var totalSecs = ms / 1000;
    var mins = Math.floor(totalSecs / 60);
    var secs = totalSecs % 60;
    return mins + ':' + (secs < 10 ? '0' : '') + secs.toFixed(2);
  }

  function updateMetricsDisplay(){
    var m = state.metrics;
    var elapsed = m.startTime ? (performance.now() - m.startTime) : (m.endTime && m.startTime ? (m.endTime - m.startTime) : 0);
    var timeStr = m.startTime ? formatTime(elapsed) : '0:00.00';
    var metricsText = 'Tiempo: ' + timeStr + ' | Pasos: ' + m.steps + ' | Swaps: ' + m.swaps + ' | Comparaciones: ' + m.comparisons;
    var elem = $('metricsDisplay');
    if(elem) elem.textContent = metricsText;
  }

  function benchmark(){
    ensurePy().then(function(p){
      if(!p){ alert('Pyodide no disponible'); return; }
      var path = getAlgoPyPath();
      loadStudentCode(path).then(function(ok){
        if(!ok){ alert('No se pudo cargar ' + path); return; }
        var sizes = [10, 25, 50, 100];
        var results = [];
        var idx = 0;
        (function runBench(){
          if(idx >= sizes.length){
            var msg = 'Benchmark completo:\n\n';
            for(var i = 0; i < results.length; i++){
              var r = results[i];
              msg += 'n=' + r.size + ': ' + r.time.toFixed(2) + 'ms (' + r.steps + ' pasos, ' + r.swaps + ' swaps)\n';
            }
            alert(msg);
            return;
          }
          var n = sizes[idx];
          var vals = [];
          for(var k = 0; k < n; k++) vals.push(Math.random() * 1000 | 0);
          pyInit(vals).then(function(){
            var t0 = performance.now();
            var steps = 0, swaps = 0;
            for(var iter = 0; iter < 100000; iter++){
              var res = pyStep();
              steps += 1;
              if(res.swap) swaps += 1;
              if(res.done) break;
            }
            var t1 = performance.now();
            results.push({ size: n, time: t1 - t0, steps: steps, swaps: swaps });
            idx += 1;
            runBench();
          });
        })();
      });
    });
  }

  // ===== listeners del pool =====
  document.addEventListener('DOMContentLoaded', function(){
    ensureCanvas();

    $('mode').addEventListener('change', function(){ state.mode = this.value; rebuildData(); });
    $('algorithm').addEventListener('change', function(){ rebuildData(); });

    $('size').addEventListener('input', function(){ $('sizeVal').textContent = String(this.value); setRangeFill(this); rebuildData(); });
    $('speed').addEventListener('input', function(){ $('speedVal').textContent = String(this.value)+' ms'; state.speed = parseInt(this.value,10); setRangeFill(this); });

    $('shuffle').addEventListener('click', function(){ onShuffle(); });
    $('play').addEventListener('click', function(){ if(!state.running) run(); });
    $('pause').addEventListener('click', function(){
      state.running=false;
      state.highlight = {a:null,b:null};
      draw();
    });
    $('step').addEventListener('click', function(){ stepOnce(); });
    $('reset').addEventListener('click', function(){ reset(); });
    $('reloadPy').addEventListener('click', function(){
      ensurePy().then(function(p){
        if(!p) return alert('Pyodide no disponible');
        loadStudentCode(getAlgoPyPath()).then(function(ok){
          if(ok){ pyInit(state.items.map(function(it){return it.value;})).then(function(){ alert('Python recargado'); }); }
          else { alert('No se pudo cargar el .py'); }
        });
      });
    });

    $('imageFile').addEventListener('change', function(e){
      var files = e && e.target ? e.target.files : null;
      var file = files && files[0]; if(!file) return;
      file.arrayBuffer().then(function(arr){
        var blob = new Blob([arr]); var img = new Image(); var url = URL.createObjectURL(blob);
        img.onload = function(){ URL.revokeObjectURL(url);
          var c = document.createElement('canvas'); c.width = img.width; c.height = img.height;
          var cctx = c.getContext('2d'); cctx.imageSmoothingEnabled = false;
          cctx.drawImage(img,0,0); state.imageBitmap = c; rebuildData();
        };
        img.src = url;
      });
    });

    $('sizeVal').textContent = $('size').value;
    $('speedVal').textContent = $('speed').value + ' ms';
    $('benchmark').addEventListener('click', function(){ benchmark(); });
    rebuildData();
  });
  </script>
</head>
<body>
  <header>
    <h1>Visualizador de Ordenamientos</h1>
    <span class="pill">Python externo (algorithms/sort_*.py)</span>
  </header>

  <main>
    <section class="controls">
      <div class="card">
        <label>Dataset</label>
        <div class="row">
          <select id="mode">
            <option value="bars">Barras (n√∫meros)</option>
            <option value="imageCols">Imagen por columnas (extensi√≥n)</option>
          </select>
          <select id="algorithm" title="Carga algorithms/sort_<valor>.py">
            <option value="bubble">Bubble Sort (PY)</option>
            <option value="insertion">Insertion Sort (PY)</option>
            <option value="selection">Selection Sort (PY)</option>
            <option value="quick">Quick Sort (PY)</option>
            <option value="merge">Merge Sort (PY)</option>
            <option value="shell">Shell Sort (PY)</option>

          </select>
        </div>
        <div style="margin-top: 12px;">
          <label>M√©tricas</label>
          <div id="metricsDisplay" class="pill" style="background:rgba(29, 58, 85, 0.6);border:1.5px solid hsl(186, 80%, 90%);padding:10px;text-align:center;font-size:14px;font-weight:500;margin-top:6px;min-height:24px;color:#d5f9ff;">
            Tiempo: 0:00.00 | Pasos: 0 | Swaps: 0 | Comparaciones: 0
          </div>
        </div>
      </div>

      <div class="card">
        <label>Tama√±o y velocidad</label>
        <div class="row">
          <div style="flex:2">
            <small class="pill">Cantidad</small>
            <input id="size" type="range" min="5" max="150" value="60" />
          </div>
          <span id="sizeVal" class="pill">60</span>
        </div>
        <div class="row" style="margin-top:8px">
          <div style="flex:2">
            <small class="pill">Velocidad (ms entre pasos)</small>
            <input id="speed" type="range" min="0" max="400" step="10" value="50" />
          </div>
          <span id="speedVal" class="pill">50 ms</span>
        </div>
      </div>

      <div class="card" id="imageCard" style="display:none">
        <label>Imagen (solo en modo ‚ÄúImagen por columnas‚Äù)</label>
        <input id="imageFile" type="file" accept="image/*" />
        <small class="pill">Se corta en <span id="imgCols">60</span> columnas y se ordena por √≠ndice original.</small>
      </div>

      <div class="card">
        <label>Acciones</label>
        <div class="btns">
          <button id="shuffle">Mezclar</button>
          <button id="play" class="primary">Reproducir</button>
          <button id="step">Paso</button>
          <button id="pause">Pausa</button>
          <button id="reset">Reset</button>
          <button id="benchmark">Benchmark</button>
          <button id="reloadPy">Recargar Python</button>
        </div>
        <div style="margin-top:8px">Ejecuci√≥n: <span class="pill" id="modeExec">Python</span></div>
      </div>
    </section>

    <section id="canvasWrap"></section>

    <div class="footer">
      Coloc√° tus algoritmos en <span class="kbd">algorithms/sort_*.py</span> con <span class="kbd">init(vals)</span> y <span class="kbd">step()</span>. Inicia con
      <span class="kbd">python -m http.server</span> y abr√≠ <span class="kbd">http://localhost:8000</span>.
    </div>
  </main>
</body>
</html>
